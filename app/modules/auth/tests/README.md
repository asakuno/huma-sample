# Auth Module Tests

このディレクトリには認証モジュールの包括的なテストスイートが含まれています。

## テストの種類

### 1. 単体テスト (Unit Tests)
- **service_test.go**: サービス層のビジネスロジックテスト
- **controller_test.go**: コントローラー層のHTTPハンドラーテスト

### 2. 結合テスト (Integration Tests)
- **integration_test.go**: APIエンドポイントの完全な結合テスト

### 3. ベンチマークテスト (Benchmark Tests)
- **benchmark_test.go**: パフォーマンステスト

### 4. テストユーティリティ
- **test_utils.go**: テスト用のヘルパー関数とモックオブジェクト

## テストの実行方法

### 全てのテストを実行
```bash
cd app/modules/auth/tests
go test -v
```

### 単体テストのみ実行
```bash
go test -v -run "Test.*Service|Test.*Controller"
```

### 結合テストのみ実行
```bash
go test -v -run "TestIntegration"
```

### ベンチマークテストを実行
```bash
go test -v -bench=. -benchmem
```

### カバレッジレポート生成
```bash
go test -coverprofile=coverage.out
go tool cover -html=coverage.out -o coverage.html
```

## テストの構造

### MockRepository
テスト用のモックリポジトリ実装で、以下の機能を提供：
- Cognitoサービスのモック
- データベース操作のモック
- エラーシミュレーション
- テストデータ管理

### TestConfig
テスト用の設定とコンポーネント：
- インメモリSQLiteデータベース
- モックリポジトリ
- テスト用サービス・コントローラー
- テスト用設定

### IntegrationTestConfig
結合テスト用の設定：
- 実際のHTTPルーター
- Huma APIインスタンス
- エンドツーエンドテスト環境

## テストケース

### サービス層テスト
- ユーザー登録（成功・失敗パターン）
- ログイン認証（成功・失敗パターン）
- トークンリフレッシュ
- パスワード変更
- ユーザー情報取得
- パスワード強度検証

### コントローラー層テスト
- HTTPリクエスト/レスポンス処理
- 認証ミドルウェア連携
- エラーハンドリング
- バリデーション

### 結合テスト
- 完全な認証フロー
- データベース操作
- 同時リクエスト処理
- エラーハンドリング
- ヘルスチェック

### ベンチマークテスト
- ユーザー登録パフォーマンス
- ログインパフォーマンス
- パスワードハッシュ化
- JWTトークン解析
- データベース操作
- 同時実行パフォーマンス
- メモリ使用量

## カバレッジ目標

- **単体テスト**: 90%以上
- **結合テスト**: 主要な業務フロー100%
- **エラーパス**: 重要なエラーケース100%

## 継続的インテグレーション

テストは以下の条件で自動実行されます：
- プルリクエスト作成時
- メインブランチへのマージ時
- リリース前

## テストデータ

テストで使用するデフォルトデータ：
- テストユーザーメール: `test@example.com`
- テストパスワード: `testpass123`
- モックCognito ID: `mock-cognito-user-id`

## 注意事項

- テストは独立して実行可能
- 各テストは自動的にクリーンアップ
- モックを使用してCognito依存を排除
- インメモリDBで高速実行